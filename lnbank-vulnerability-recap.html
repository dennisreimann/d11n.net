<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta http-equiv="X-UA-Compatible" content="ie=edge"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="keywords" content="BTCPay Server,LNbank"/><meta name="description" content="This post summarizes the critical vulnerability in the LNbank plugin, which got announced last week and how we intend to prevent something similar from happening in the future.
"/><meta name="theme-color" content="#0d151e"/><meta name="lightning" content="lnurlp:donate@d11n.net"/><meta name="msapplication-TileColor" content="#0d151e"/><meta name="msapplication-config" content="/browserconfig.xml"/><meta property="twitter:creator" content="@dennisreimann"/><meta property="twitter:card" content="summary_large_image"/><meta property="twitter:title" content="LNbank Vulnerability Recap ¬∑ d11n üçØü¶°‚ö°Ô∏èüïóüîó"/><meta property="twitter:description" content="This post summarizes the critical vulnerability in the LNbank plugin, which got announced last week and how we intend to prevent something similar from happening in the future.
"/><meta property="twitter:image" content="https://d11n.net/images/lnbank/vulnerability.png"/><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"/><link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#0d151e"/><link rel="stylesheet" href="/styles/main.css"/><link rel="manifest" href="/site.webmanifest"/><title>LNbank Vulnerability Recap ¬∑ d11n üçØü¶°‚ö°Ô∏èüïóüîó</title></head><body><header class="header"><div class="wrap"><a class="home" href="/"><svg viewbox="0 0 423 369" xmlns="http://www.w3.org/2000/svg" class="logo">
  <g fill-rule="nonzero" fill="none">
    <path d="M225.233 70.6l-51.9 297.4h-45.6L179.63 70.6h45.603zm82-70l-51.9 297.4h-45.6L261.63.6h45.603z" class="accent" />
    <path d="M422.2 174c0 3.8-.25 8.1-.75 12.9-.5 4.8-1.25 9.6-2.25 14.4L402.7 297h-43.8l16.8-95.7c.4-1.8.7-3.65.9-5.55.2-1.9.3-3.75.3-5.55 0-4.2-.85-7.8-2.55-10.8-1.7-3-4.95-4.5-9.75-4.5-6 0-11.15 2.85-15.45 8.55-4.3 5.7-7.25 13.05-8.85 22.05L324.4 297h-43.8l20.7-117.9 1.5-9.15c.6-3.7 1.15-7.4 1.65-11.1.444-3.289.889-6.38 1.333-9.274l.478-3.106c.337-2.247.583-4.07.739-5.47h41.4l-.204 1.463c-.278 2.033-.578 4.4-.9 7.1l-.246 2.087c-.5 4.3-1.05 8.35-1.65 12.15h.6c4-7.8 9.5-14.35 16.5-19.65 7-5.3 15.3-7.95 24.9-7.95 6.2 0 11.55 1.15 16.05 3.45 4.5 2.3 8.1 5.25 10.8 8.85 2.7 3.6 4.7 7.65 6 12.15 1.3 4.5 1.95 8.95 1.95 13.35zM155.1 70.2L115.5 297H73.8l3.3-20.1h-.3c-3.6 7-8.2 12.9-13.8 17.7-5.6 4.8-13.1 7.2-22.5 7.2-6.8 0-12.75-1.4-17.85-4.2-5.1-2.8-9.3-6.65-12.6-11.55-3.3-4.9-5.8-10.8-7.5-17.7C.85 261.45 0 253.9 0 245.7c0-12.2 1.45-24.75 4.35-37.65 2.9-12.9 7.2-24.7 12.9-35.4S29.9 153.2 38.1 146.4c8.2-6.8 17.7-10.2 28.5-10.2 9 0 15.8 2.05 20.4 6.15 4.6 4.1 7.5 9.45 8.7 16.05h.9l15.6-88.2h42.9zM74.4 173.7c-5.2 0-9.7 2.2-13.5 6.6-3.8 4.4-7 9.85-9.6 16.35-2.6 6.5-4.55 13.5-5.85 21-1.3 7.5-1.95 14.35-1.95 20.55 0 7.6 1.25 13.8 3.75 18.6 2.5 4.8 6.65 7.2 12.45 7.2 4.8 0 9.1-2.15 12.9-6.45 3.8-4.3 7-9.65 9.6-16.05 2.6-6.4 4.6-13.3 6-20.7 1.4-7.4 2.1-14.1 2.1-20.1 0-8-1.25-14.5-3.75-19.5s-6.55-7.5-12.15-7.5z" class="color" />
  </g>
</svg>
</a></div></header><main class="main"><div class="wrap"><div class="article lnbank-vulnerability-recap"><h1 id="lnbank-vulnerability-recap" tabindex="-1"><a class="header-anchor" href="#lnbank-vulnerability-recap">#</a> LNbank Vulnerability Recap</h1>
<p>Last week, a critical vulnerability was identified in the LNbank plugin, which I developed as a plugin for BTCPay Server. This post aims to outline what transpired and steps I, as a maintainer of the plugin, and BTCPay Server team are taking to prevent similar occurrences in the future.</p>
<h2 id="what-is-lnbank%3F" tabindex="-1"><a class="header-anchor" href="#what-is-lnbank%3F">#</a> What is LNbank?</h2>
<p>LNbank, is a third-party plugin which allows an administrator of a BTCPay Server, to become custodian and allow users of their server to accept Lightning payments. In essence, LNbank is a custodian wallet system built on top of lightning. As the plugin description says, it enables an ‚ÄúUncle Jim‚Äù mode for your family and friends.</p>
<h2 id="btcpay-server-plugin-system" tabindex="-1"><a class="header-anchor" href="#btcpay-server-plugin-system">#</a> BTCPay Server plugin system</h2>
<p>The Plugin system in BTCPay Server, allows third-party developers to develop and build features into the BTCPay Server without being burdened by the reviews of the core team and processes for the core software. This allows developers to innovate quicker, build out features that may not be planned in the current roadmap for BTCPay Server, and users to have access to personalized features, without being a bottleneck to the core software. The plugins don‚Äôt undergo the review by the core team and can be published by anyone.</p>
<h2 id="what-happened%3F" tabindex="-1"><a class="header-anchor" href="#what-happened%3F">#</a> What happened?</h2>
<p>Between December 7th, Thursday evening and December 8th Friday morning, two reports surfaced via BTCPay Server‚Äôs Mattermost and Telegram support channels. They pointed to an urgent security issue in LNbank.</p>
<p>Upon receiving these reports, I immediately began an investigation and was assisted by logs provided by the affected users. These logs uncovered that a malicious actor had actively exploited a flaw to withdraw amounts exceeding their LNbank wallet balance. This was achieved through issuing multiple concurrent payments/withdrawals. Due to timing discrepancies, these requests bypassed the wallet‚Äôs balance check, which, although had some safeguards around concurrent requests, were not enough.</p>
<p>Here‚Äôs the <strong>technical breakdown</strong>: if a new request was initiated before the previous withdrawal was recorded in the database, the subsequent balance check used outdated information. This loophole enabled the attacker to repeatedly withdraw their wallet balance, refilling and exploiting it several times, draining substantial liquidity from the Lightning node of a custodian server admin.</p>
<h2 id="immediate-response-and-version-update" tabindex="-1"><a class="header-anchor" href="#immediate-response-and-version-update">#</a> Immediate response and version update</h2>
<p>Recognizing the severity of the vulnerability, I released LNbank version 1.8.9 on Friday, December 8th afternoon, less than 24 hours after the report to address it. In BTCPay Server or LNBank plugin, there‚Äôs no user tracking, so we had to reach out to active users of our community chats that may be running an instance for other users. Assisted by a few other contributors and community members, we alerted these instances privately and then alerted users about the vulnerability through all our public channels, urging them to update immediately and prioritizing the protection of other users who may be impacted.</p>
<h2 id="impact" tabindex="-1"><a class="header-anchor" href="#impact">#</a> Impact</h2>
<p>Impacted are users using LNbank plugin versions older than 1.8.9, especially public servers, that allow anyone (including the malicious attacker) to register on their instance and execute the attack.</p>
<h2 id="mitigation" tabindex="-1"><a class="header-anchor" href="#mitigation">#</a> Mitigation</h2>
<p>If you‚Äôre using LNbank plugin &lt;1.8.9 and have public registration opened to your server immediately update to 1.8.9 to mitigate the vulnerability.</p>
<h2 id="future-safeguards-and-enhancements" tabindex="-1"><a class="header-anchor" href="#future-safeguards-and-enhancements">#</a> Future safeguards and enhancements</h2>
<p>With regards to LNbank there were already plans to restrict the access to vetted users only, in the light of this event this feature will be prioritized. Prior to this incident work was already started to separate banks and offer hosts more fine-grained access control to them. The ability for plugins to have their own CI pipelines for testing is something we want to enable for BTCPay Server plugins as well, but it requires some more infrastructural work to make it happen.</p>
<p>The BTCPay Server core, recognized there are some improvements to be made as well:</p>
<ul>
<li>Improving communication in case of critical vulnerabilities even further, potentially implementing RSS and enhancing our notification system to have the ability to alert users when a critical vulnerability is reported.</li>
<li>Ensuring users are aware of the potential dangers of using third-party plugins</li>
<li>Outlining dangers that come with opening up instances for public registrations, especially when hot wallets are in play.</li>
<li>Fine-graining user registration system and allowing better ways for admins to vet their users.</li>
<li>As part of the official roadmap, the biggest focus is introducing a cross-platform application that enables a seamless non-custodial Bitcoin and lightning experience, even on shared instances.</li>
</ul>
<h2 id="saying-sorry" tabindex="-1"><a class="header-anchor" href="#saying-sorry">#</a> Saying sorry</h2>
<p>I feel sorry for every user of the plugin who was affected by this vulnerability and every sat lost. I am thankful for the user who provided the information to prevent further loss and helped debug this.
In the discussions that came up after this vulnerability was announced, it turned out that there is also a case with severe loss. Up to now I haven‚Äôt addressed it publicly and I am also sorry for that.</p>
<p>Though I know this won‚Äôt make up for it I want everyone to know that I am very sorry about what happened. I don‚Äôt want to justify it in any way, yet to be realistic I know that these kind of things can happen. Nevertheless, I want this at least to be more than words and even though it will be more of a symbolic move than substantially helping with the loss, I‚Äôd like to do the following ‚Ä¶</p>
<p>The LNbank plugin received around 500k sats in donations, at least that‚Äôs what I can roughly attribute to it. I will match and double it, so that there are 2.1M sats, which I‚Äôll donate to those impacted. Everyone who feels like they got value out of LNbank can please also donate to that cause.</p>
<p>You can donate to <a href="https://stacker.news/items/347361">Hugo‚Äôs case</a> via <code>hugo@wallets.fyoumoneypod.com</code> or to <code>bc1qz8dxk6h8gha5qvsnw67rjzz3xn6t4k0wmafqz3</code>.</p>
</div></div></main><footer class="footer"><div class="wrap"><p>Published at block height <time datetime="2023-12-15">821285</time>. <a href="https://github.com/dennisreimann/d11n.net/blob/master/articles/821285-lnbank-vulnerability-recap.md">(GitHub)</a></p><p>Website last updated at block height <time datetime="2025-03-22">888935</time>.</p></div></footer></body></html>